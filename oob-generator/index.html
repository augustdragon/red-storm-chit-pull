<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Red Storm Order of Battle Generator</title>
  <!-- Updated: Table A implementation with nested roll system -->
  <link rel="stylesheet" href="../shared/red-storm.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">Red Storm</div>
      <div class="subtitle">Order of Battle Generator</div>
    </div>

    <a href="../" class="back-link">‚Üê Back to Red Storm Tools</a>

    <div class="m    function removeResult(resultId) {
      results = results.filter(r => r.id !== resultId);
      
      // Check if all results are gone
      if (results.length === 0) {
        hasGeneratedResults = false;
        updateDateButtonStates(); // Unlock date selection
      }
      
      updateResultsDisplay();
    }content">
      <!-- Scenario Date Toggle -->
      <div class="section" id="scenarioToggle">
        <div class="section-title">Scenario Date</div>
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button class="scenario-date-button" id="preDate" onclick="setScenarioDate('pre')">
            Pre-6/1/87
          </button>
          <button class="scenario-date-button" id="postDate" onclick="setScenarioDate('post')">
            6/1/87 or later
          </button>
        </div>
        <div class="scenario-status" id="scenarioStatus" style="margin-top: 10px; text-align: center; font-size: 14px; color: #b4c4b4;">
          Select scenario date to enable table generation
        </div>
      </div>

      <!-- Table Selection Section -->
            <!-- Table Selection Section -->
      <div class="section" id="tableSelection" style="opacity: 0.5; pointer-events: none;">
        <div class="section-title">Select Order of Battle Table</div>
        
        <!-- Invisible width placeholder to maintain consistent layout -->
        <div style="visibility: hidden; height: 0; overflow: hidden; margin-bottom: 0;">
          <div style="background-color: #4a5a4a; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: bold; margin-bottom: 5px;">NATO Table B - CAP Flight [4ATAF, 6/1/87+]</div>
              <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">UK: 1 x {2} Tornado F2A, CAP (aircraft: 10)</div>
            </div>
            <button style="padding: 6px 12px; margin-left: 10px; flex-shrink: 0;">Remove</button>
          </div>
        </div>
        
        <div class="faction-section">
          <div class="faction-header nato-header">NATO Tables</div>
          <div class="table-grid">
            <button class="table-button nato-table" onclick="selectTable('A', 'NATO')">A</button>
            <button class="table-button nato-table" onclick="selectTable('B', 'NATO')">B</button>
            <button class="table-button nato-table" onclick="selectTable('C', 'NATO')">C</button>
            <button class="table-button nato-table" onclick="selectTable('D', 'NATO')">D</button>
            <button class="table-button nato-table" onclick="selectTable('E', 'NATO')">E</button>
            <button class="table-button nato-table" onclick="selectTable('F', 'NATO')">F</button>
          </div>
        </div>

        <div class="faction-section">
          <div class="faction-header warsaw-header">Warsaw Pact Tables</div>
          <div class="table-grid">
            <button class="table-button warsaw-table" onclick="selectTable('G', 'Warsaw Pact')">G</button>
            <button class="table-button warsaw-table" onclick="selectTable('H', 'Warsaw Pact')">H</button>
            <button class="table-button warsaw-table" onclick="selectTable('I', 'Warsaw Pact')">I</button>
            <button class="table-button warsaw-table" onclick="selectTable('J', 'Warsaw Pact')">J</button>
            <button class="table-button warsaw-table" onclick="selectTable('K', 'Warsaw Pact')">K</button>
            <button class="table-button warsaw-table" onclick="selectTable('L', 'Warsaw Pact')">L</button>
          </div>
        </div>
      </div>

      <!-- Roll Input Section -->
      <div class="roll-input-section" id="rollInputSection">
        <div class="selected-table" id="selectedTableDisplay"></div>
        
        <div class="input-group">
          <label for="rollCountBasic">Number of rolls:</label>
          <input type="number" id="rollCountBasic" min="1" max="20" value="1" />
        </div>
        
        <div class="action-buttons">
          <button class="action-button roll-button" onclick="makeRolls()">Make Rolls</button>
          <button class="action-button" style="background-color: #6d5d47;" onclick="viewTable()">View Table</button>
          <button class="action-button cancel-button" onclick="cancelSelection()">Cancel</button>
        </div>
      </div>

      <!-- Variable Selection Section -->
      <div class="roll-input-section" id="variableSelectionSection">
        <div class="selected-table" id="variableTableDisplay"></div>
        
        <!-- ATAF Zone Selection -->
        <div class="input-group" id="atafSelection" style="display: none;">
          <label>ATAF Zone:</label>
          <select id="atafZone" style="padding: 8px 12px; border: 1px solid #6a7a6a; border-radius: 4px; background-color: #5a6a5a; color: #f4f4f4; font-size: 16px;">
            <option value="2ATAF">2ATAF</option>
            <option value="4ATAF">4ATAF</option>
          </select>
        </div>
        
        <!-- Scenario Date Context -->
        <div class="input-group" id="dateContext" style="display: none;">
          <div style="background-color: #2a3a2a; padding: 8px 12px; border-radius: 4px; font-size: 14px; color: #b4c4b4; text-align: center;">
            <span id="dateContextMessage">Scenario Date Context: <span id="currentScenarioDate">Not set</span></span>
          </div>
        </div>
        
        <div class="input-group">
          <label for="rollCountVariable">Number of rolls:</label>
          <input type="number" id="rollCountVariable" min="1" max="20" value="1" />
        </div>
        
        <div class="action-buttons">
          <button class="action-button roll-button" onclick="makeRollsWithVariables()">Make Rolls</button>
          <button class="action-button" style="background-color: #6d5d47;" onclick="viewTableWithVariables()">View Table</button>
          <button class="action-button cancel-button" onclick="cancelVariableSelection()">Cancel</button>
        </div>
      </div>

      <!-- Results Section -->
      <div class="section results-section" id="resultsSection" style="display: none;">
        <div class="results-header">
          <div class="section-title">Generated Results</div>
          <button class="action-button clear-results" onclick="clearAllResults()">Clear All</button>
        </div>
        
        <div class="results-list" id="resultsList">
          <div class="empty-results">No results generated yet</div>
        </div>
      </div>

      <!-- Table View Overlay -->
      <div class="table-view-overlay" id="tableViewOverlay" style="display: none;">
        <div class="table-view-modal">
          <div class="section-title" id="tableViewTitle"></div>
          <div id="tableViewContent"></div>
          <div style="text-align: center; margin-top: 20px;">
            <button class="action-button cancel-button" onclick="hideTableView()">Close Table View</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Application state
    let selectedTable = null;
    let selectedFaction = null;
    let scenarioDate = null; // 'pre' or 'post'
    let results = [];
    let resultCounter = 1;
    let hasGeneratedResults = false; // Track if any results exist
    
    // Set scenario date
    function setScenarioDate(dateValue) {
      // Don't allow changing date if results exist
      if (hasGeneratedResults) {
        alert('Cannot change scenario date while flights exist. Clear all results first.');
        return;
      }
      
      scenarioDate = dateValue;
      
      // Update button styles
      document.getElementById('preDate').classList.toggle('active', dateValue === 'pre');
      document.getElementById('postDate').classList.toggle('active', dateValue === 'post');
      
      // Update status
      const dateText = dateValue === 'pre' ? 'Pre-6/1/87' : '6/1/87 or later';
      document.getElementById('scenarioStatus').textContent = `Scenario Date: ${dateText}`;
      
      // Enable table selection if disabled
      const tableSection = document.getElementById('tableSelection');
      tableSection.style.opacity = '1';
      tableSection.style.pointerEvents = 'auto';
    }
    
    // Update date button states based on results
    function updateDateButtonStates() {
      const preButton = document.getElementById('preDate');
      const postButton = document.getElementById('postDate');
      
      if (hasGeneratedResults) {
        // Lock the buttons - truly disable them
        preButton.style.opacity = '0.5';
        postButton.style.opacity = '0.5';
        preButton.style.cursor = 'not-allowed';
        postButton.style.cursor = 'not-allowed';
        preButton.style.pointerEvents = 'none';
        postButton.style.pointerEvents = 'none';
        
        // Update status to show locked state
        const dateText = scenarioDate === 'pre' ? 'Pre-6/1/87' : '6/1/87 or later';
        document.getElementById('scenarioStatus').textContent = `Scenario Date: ${dateText} (locked - clear results to change)`;
      } else {
        // Unlock the buttons
        preButton.style.opacity = '1';
        postButton.style.opacity = '1';
        preButton.style.cursor = 'pointer';
        postButton.style.cursor = 'pointer';
        preButton.style.pointerEvents = 'auto';
        postButton.style.pointerEvents = 'auto';
        
        if (scenarioDate) {
          const dateText = scenarioDate === 'pre' ? 'Pre-6/1/87' : '6/1/87 or later';
          document.getElementById('scenarioStatus').textContent = `Scenario Date: ${dateText}`;
        } else {
          document.getElementById('scenarioStatus').textContent = 'Select scenario date to enable table generation';
        }
      }
    }

    // OOB Tables with actual game data
    const oobTables = {
      'A': { 
        name: 'NATO Table A - QRA Flight', 
        faction: 'NATO',
        description: '1 x {2} [QRA], CAP',
        flightSize: 2,
        hasATAF: true,
        hasDate: true,
        variants: {
          '2ATAF': {
            'pre': {
              nations: {
                '1-4': {
                  name: 'UK',
                  aircraft: {
                    '1-6': 'FGR2',
                    '7-10': 'Harrier GR3'
                  }
                },
                '5-6': {
                  name: 'BE/NE',
                  aircraft: {
                    '1-5': 'F-16A(BE)',
                    '6-9': 'F-16A(NE)',
                    '10': 'NF-5A'
                  }
                },
                '7-10': {
                  name: 'FRG',
                  aircraft: {
                    '1-10': 'F-4F'
                  }
                }
              }
            },
            'post': {
              nations: {
                '1-6': {
                  name: 'UK',
                  aircraft: {
                    '1-6': 'FGR2',
                    '7-10': 'Harrier GR3'
                  }
                },
                '7': {
                  name: 'BE/NE',
                  aircraft: {
                    '1-5': 'F-16A(BE)',
                    '6-9': 'F-16A(NE)',
                    '10': 'NF-5A'
                  }
                },
                '8-10': {
                  name: 'FRG',
                  aircraft: {
                    '1-10': 'F-4F'
                  }
                }
              }
            }
          },
          '4ATAF': {
            'pre': {
              nations: {
                '1-5': {
                  name: 'US',
                  aircraft: {
                    '1-2': 'F-4D',
                    '3-4': 'F-4E',
                    '5-8': 'F-16A',
                    '9-10': 'F-16C'
                  }
                },
                '6-8': {
                  name: 'FRG',
                  aircraft: {
                    '1-8': 'F-4F',
                    '9-10': 'F-104G'
                  }
                },
                '9-10': {
                  name: 'CAN',
                  aircraft: {
                    '1-8': 'CF-18A',
                    '9-10': 'CF-5A'
                  }
                }
              }
            },
            'post': {
              nations: {
                '1-7': {
                  name: 'US',
                  aircraft: {
                    '1-2': 'F-4D',
                    '3-4': 'F-4E',
                    '5-8': 'F-16A',
                    '9-10': 'F-16C'
                  }
                },
                '8-9': {
                  name: 'FRG',
                  aircraft: {
                    '1-8': 'F-4F',
                    '9-10': 'F-104G'
                  }
                },
                '10': {
                  name: 'CAN',
                  aircraft: {
                    '1-8': 'CF-18A',
                    '9-10': 'CF-5A'
                  }
                }
              }
            }
          }
        }
      },
      'B': { 
        name: 'NATO Table B - CAP Flight', 
        faction: 'NATO',
        hasATAF: true,
        hasDate: true,
        description: 'NATO CAP Flight - Flights in the air at designated Orbit Points',
        result: '1 x {2} [CAP], CAP',
        zones: {
          '2ATAF': {
            'pre': {
              nations: {
                '1-2': {
                  name: 'US',
                  aircraft: {
                    '1-2': 'F-15A',
                    '3-6': 'F-15C',
                    '7-9': 'F-4E',
                    '10': 'F-4D'
                  }
                },
                '3-5': {
                  name: 'UK',
                  aircraft: {
                    '1-7': 'FGR2',
                    '8-10': 'Tornado F2A'
                  }
                },
                '6-7': {
                  name: 'BE/NE',
                  aircraft: {
                    '1-5': 'F-16A(BE)',
                    '6-10': 'F-16A(NE)'
                  }
                },
                '8-10': {
                  name: 'FRG',
                  aircraft: {
                    '1-10': 'F-4F'
                  }
                }
              }
            },
            'post': {
              nations: {
                '1-4': {
                  name: 'US',
                  aircraft: {
                    '1-2': 'F-15A',
                    '3-6': 'F-15C',
                    '7-9': 'F-4E',
                    '10': 'F-4D'
                  }
                },
                '5-6': {
                  name: 'UK',
                  aircraft: {
                    '1-7': 'FGR2',
                    '8-10': 'Tornado F2A'
                  }
                },
                '7-8': {
                  name: 'BE/NE',
                  aircraft: {
                    '1-5': 'F-16A(BE)',
                    '6-10': 'F-16A(NE)'
                  }
                },
                '9-10': {
                  name: 'FRG',
                  aircraft: {
                    '1-10': 'F-4F'
                  }
                }
              }
            }
          },
          '4ATAF': {
            'pre': {
              nations: {
                '1-5': {
                  name: 'US',
                  aircraft: {
                    '1-2': 'F-15A',
                    '3-6': 'F-15C',
                    '7-9': 'F-4E',
                    '10': 'F-4D'
                  }
                },
                '6-8': {
                  name: 'FRG',
                  aircraft: {
                    '1-9': 'F-4F',
                    '10': 'F-104G'
                  }
                },
                '9-10': {
                  name: 'CAN',
                  aircraft: {
                    '1-9': 'CF-18A',
                    '10': 'CF-5A'
                  }
                }
              }
            },
            'post': {
              nations: {
                '1-7': {
                  name: 'US',
                  aircraft: {
                    '1-2': 'F-15A',
                    '3-6': 'F-15C',
                    '7-9': 'F-4E',
                    '10': 'F-4D'
                  }
                },
                '8-9': {
                  name: 'FRG',
                  aircraft: {
                    '1-9': 'F-4F',
                    '10': 'F-104G'
                  }
                },
                '10': {
                  name: 'CAN',
                  aircraft: {
                    '1-9': 'CF-18A',
                    '10': 'CF-5A'
                  }
                }
              }
            }
          }
        }
      },
      'C': { 
        name: 'NATO Table C - Bombing Raid', 
        faction: 'NATO',
        hasTasking: true,
        hasDate: true,
        description: 'NATO Bombing Raid - Package of CAP, SEAD, and Bombing flights',
        result: '4 x {2} [CAP], CAP; 4 x {2} [SEAD], SEAD; 4 x {4} [Bombing], Bombing',
        taskings: {
          'CAP': {
            'pre': {
              nations: {
                '1-2': {
                  name: 'US',
                  aircraft: {
                    '1-2': 'F-15A',
                    '3-6': 'F-15C',
                    '7-8': 'F-4E',
                    '9': 'F-4D',
                    '10': 'F-16C'
                  }
                },
                '3-5': {
                  name: 'UK',
                  aircraft: {
                    '1-7': 'FGR2',
                    '8-10': 'Tornado F2A'
                  }
                },
                '6-7': {
                  name: 'BE/NE',
                  aircraft: {
                    '1-5': 'F-16A(BE)',
                    '6-10': 'F-16A(NE)'
                  }
                },
                '8-10': {
                  name: 'FRG',
                  aircraft: {
                    '1-10': 'F-4F'
                  }
                }
              }
            },
            'post': {
              nations: {
                '1-4': {
                  name: 'US',
                  aircraft: {
                    '1-2': 'F-15A',
                    '3-6': 'F-15C',
                    '7-8': 'F-4E',
                    '9': 'F-4D',
                    '10': 'F-16C'
                  }
                },
                '5-6': {
                  name: 'UK',
                  aircraft: {
                    '1-7': 'FGR2',
                    '8-10': 'Tornado F2A'
                  }
                },
                '7-8': {
                  name: 'BE/NE',
                  aircraft: {
                    '1-5': 'F-16A(BE)',
                    '6-10': 'F-16A(NE)'
                  }
                },
                '9-10': {
                  name: 'FRG',
                  aircraft: {
                    '1-10': 'F-4F'
                  }
                }
              }
            }
          },
          'SEAD': {
            'pre': {
              nations: {
                '1-4': {
                  name: 'US',
                  aircraft: {
                    '1-3': 'F-4G',
                    '4-8': 'F-4G/F-4E',
                    '9': 'F-4G/F-16C',
                    '10': 'A-7D'
                  }
                },
                '5-6': {
                  name: 'UK',
                  aircraft: {
                    '1-5': 'Torn GR1',
                    '6-8': 'Harrier GR3',
                    '9-10': 'Jaguar GR1A'
                  }
                },
                '7-9': {
                  name: 'FRG',
                  aircraft: {
                    '1-5': 'Torn IDS',
                    '6-9': 'F-4F',
                    '8-9': 'Alpha Jet',
                    '10': 'F-104G'
                  }
                },
                '9': {
                  name: 'BE',
                  aircraft: {
                    '1-5': 'F-16A',
                    '6-10': 'Mirage 5BA'
                  }
                },
                '10': {
                  name: 'NE/CAN',
                  aircraft: {
                    '1-5': 'F-16A',
                    '6-10': 'CF-18A'
                  }
                }
              }
            },
            'post': {
              nations: {
                '1-6': {
                  name: 'US',
                  aircraft: {
                    '1-3': 'F-4G',
                    '4-8': 'F-4G/F-4E',
                    '9': 'F-4G/F-16C',
                    '10': 'A-7D'
                  }
                },
                '7': {
                  name: 'UK',
                  aircraft: {
                    '1-5': 'Torn GR1',
                    '6-8': 'Harrier GR3',
                    '9-10': 'Jaguar GR1A'
                  }
                },
                '8-9': {
                  name: 'FRG',
                  aircraft: {
                    '1-5': 'Torn IDS',
                    '6-9': 'F-4F',
                    '8-9': 'Alpha Jet',
                    '10': 'F-104G'
                  }
                },
                '10': {
                  name: 'NE/CAN',
                  aircraft: {
                    '1-5': 'F-16A',
                    '6-10': 'CF-18A'
                  }
                }
              }
            }
          },
          'Bombing': {
            'pre': {
              nations: {
                '1-4': {
                  name: 'US',
                  aircraft: {
                    '1-2': 'F-16A',
                    '3': 'F-16C',
                    '4-6': 'A-10A',
                    '7': 'A-7D',
                    '8-10': 'F-4E'
                  }
                },
                '5-6': {
                  name: 'UK',
                  aircraft: {
                    '1-5': 'Torn GR1',
                    '6-9': 'Harrier GR3',
                    '10': 'Jaguar GR1A'
                  }
                },
                '7-9': {
                  name: 'FRG',
                  aircraft: {
                    '1-4': 'Torn IDS',
                    '5-7': 'F-4F',
                    '8-9': 'Alpha Jet',
                    '10': 'F-104G'
                  }
                },
                '9': {
                  name: 'BE',
                  aircraft: {
                    '1-5': 'F-16A',
                    '6-10': 'Mirage 5BA'
                  }
                },
                '10': {
                  name: 'NE/CAN',
                  aircraft: {
                    '1-4': 'F-16A',
                    '5-10': 'CF-18A'
                  }
                }
              }
            },
            'post': {
              nations: {
                '1-6': {
                  name: 'US',
                  aircraft: {
                    '1-2': 'F-16A',
                    '3': 'F-16C',
                    '4-6': 'A-10A',
                    '7': 'A-7D',
                    '8-10': 'F-4E'
                  }
                },
                '7': {
                  name: 'UK',
                  aircraft: {
                    '1-5': 'Torn GR1',
                    '6-9': 'Harrier GR3',
                    '10': 'Jaguar GR1A'
                  }
                },
                '8-9': {
                  name: 'FRG',
                  aircraft: {
                    '1-4': 'Torn IDS',
                    '5-7': 'F-4F',
                    '8-9': 'Alpha Jet',
                    '10': 'F-104G'
                  }
                },
                '10': {
                  name: 'NE/CAN',
                  aircraft: {
                    '1-4': 'F-16A',
                    '5-10': 'CF-18A'
                  }
                }
              }
            }
          }
        }
      },
      'D': { name: 'NATO Table D', faction: 'NATO', results: {} },
      'E': { name: 'NATO Table E', faction: 'NATO', results: {} },
      'F': { name: 'NATO Table F', faction: 'NATO', results: {} },
      'G': { name: 'Warsaw Pact Table G', faction: 'Warsaw Pact', results: {} },
      'H': { name: 'Warsaw Pact Table H', faction: 'Warsaw Pact', results: {} },
      'I': { name: 'Warsaw Pact Table I', faction: 'Warsaw Pact', results: {} },
      'J': { name: 'Warsaw Pact Table J', faction: 'Warsaw Pact', results: {} },
      'K': { name: 'Warsaw Pact Table K', faction: 'Warsaw Pact', results: {} },
      'L': { name: 'Warsaw Pact Table L', faction: 'Warsaw Pact', results: {} }
    };

    function selectTable(tableId, faction) {
      selectedTable = tableId;
      selectedFaction = faction;
      
      // Check if scenario date is set
      if (!scenarioDate) {
        alert('Please select a scenario date first.');
        return;
      }
      
      const table = oobTables[tableId];
      
      // First, clear any previously active sections
      document.getElementById('rollInputSection').classList.remove('active');
      document.getElementById('variableSelectionSection').classList.remove('active');
      
      // Check if this table has variables that need to be selected
      if (table.hasATAF) {
        const displayText = `${faction} Table ${tableId}`;
        document.getElementById('variableTableDisplay').textContent = displayText;
        
        // Show/hide variable selections based on table requirements
        const atafSelection = document.getElementById('atafSelection');
        
        if (table.hasATAF) {
          atafSelection.style.display = 'flex';
        } else {
          atafSelection.style.display = 'none';
        }
        
        document.getElementById('variableSelectionSection').classList.add('active');
        document.getElementById('rollCountVariable').focus();
      } else if (table.hasTasking) {
        // Table C: Has taskings but no user selection needed - generates all three taskings per roll
        const displayText = `${faction} Table ${tableId}`;
        document.getElementById('selectedTableDisplay').textContent = displayText;
        document.getElementById('rollInputSection').classList.add('active');
        document.getElementById('rollCountBasic').focus();
      } else {
        // No variables needed, use original flow
        const displayText = `${faction} Table ${tableId}`;
        document.getElementById('selectedTableDisplay').textContent = displayText;
        document.getElementById('rollInputSection').classList.add('active');
        document.getElementById('rollCountBasic').focus();
      }
    }

    function cancelSelection() {
      selectedTable = null;
      selectedFaction = null;
      document.getElementById('rollInputSection').classList.remove('active');
      document.getElementById('rollCountBasic').value = 1;
    }

    function cancelVariableSelection() {
      selectedTable = null;
      selectedFaction = null;
      document.getElementById('variableSelectionSection').classList.remove('active');
      document.getElementById('rollCountVariable').value = 1;
    }

    function makeRollsWithVariables() {
      if (!selectedTable) return;
      
      const rollCount = parseInt(document.getElementById('rollCountVariable').value);
      if (rollCount < 1 || rollCount > 20) {
        alert('Please enter a number between 1 and 20');
        return;
      }

      const table = oobTables[selectedTable];
      
      // Get variable selections
      const atafZone = document.getElementById('atafZone').value;
      // Use global scenario date instead of dropdown
      const selectedScenarioDate = scenarioDate;
      
      for (let i = 0; i < rollCount; i++) {
        const result = getTableResultWithVariables(selectedTable, atafZone, selectedScenarioDate);
        
        const resultEntry = {
          id: resultCounter++,
          table: selectedTable,
          faction: selectedFaction,
          tableName: table.name,
          atafZone: atafZone,
          scenarioDate: scenarioDate,
          nationRoll: result.nationRoll,
          aircraftRoll: result.aircraftRoll,
          nationName: result.nationName,
          result: result.text,
          timestamp: new Date().getTime() + i // Ensure unique timestamps
        };
        
        results.unshift(resultEntry);
        hasGeneratedResults = true; // Mark that results exist
      }
      
      updateResultsDisplay();
      updateDateButtonStates(); // Update button states
    }

    function viewTableWithVariables() {
      if (!selectedTable) return;
      
      const atafZone = document.getElementById('atafZone').value;
      // Use global scenario date
      const selectedScenarioDate = scenarioDate;
      
      viewTableStructure(selectedTable, atafZone, selectedScenarioDate);
    }

    function makeRolls() {
      if (!selectedTable) return;
      
      const rollCount = parseInt(document.getElementById('rollCountBasic').value);
      if (rollCount < 1 || rollCount > 20) {
        alert('Please enter a number between 1 and 20');
        return;
      }

      // Check if Table C and scenario date is required
      if (selectedTable === 'C' && !scenarioDate) {
        alert('Please select a scenario date first.');
        return;
      }

      const table = oobTables[selectedTable];
      
      for (let i = 0; i < rollCount; i++) {
        let result;
        
        // Table C needs scenario date but no ATAF zone
        if (selectedTable === 'C') {
          result = getTableResultWithVariables(selectedTable, null, scenarioDate);
        } else {
          result = getTableResult(selectedTable);
        }
        
        const resultEntry = {
          id: resultCounter++,
          table: selectedTable,
          faction: selectedFaction,
          tableName: table.name,
          nationRoll: result.nationRoll,
          aircraftRoll: result.aircraftRoll,
          result: result.text,
          timestamp: new Date().getTime() + i // Ensure unique timestamps
        };
        
        results.unshift(resultEntry);
        hasGeneratedResults = true; // Mark that results exist
      }
      
      updateResultsDisplay();
      updateDateButtonStates(); // Update button states
      cancelSelection();
    }

    function getTableResultWithVariables(tableId, atafZone, scenarioDate) {
      const table = oobTables[tableId];
      
      if (tableId === 'A') {
        // Table A: NATO QRA Flight - two-roll system with variables
        const variant = table.variants[atafZone][scenarioDate];
        const nationRoll = Math.floor(Math.random() * 10) + 1;
        
        // Determine nation based on roll and variant
        let selectedNation, nationName;
        for (const [nationRange, nationData] of Object.entries(variant.nations)) {
          const [min, max] = parseRange(nationRange);
          if (nationRoll >= min && nationRoll <= max) {
            selectedNation = nationData;
            nationName = nationData.name;
            break;
          }
        }
        
        // Roll for aircraft within that nation
        const aircraftRoll = Math.floor(Math.random() * 10) + 1;
        let aircraftType = null;
        
        // Find matching aircraft based on roll ranges
        for (const [range, aircraft] of Object.entries(selectedNation.aircraft)) {
          const [min, max] = parseRange(range);
          if (aircraftRoll >= min && aircraftRoll <= max) {
            // Use aircraft name exactly as defined in source data
            aircraftType = aircraft;
            break;
          }
        }
        
        const resultText = `${nationName}: 1 x {${table.flightSize}} ${aircraftType}, CAP`;
        
        return {
          nationRoll: nationRoll,
          aircraftRoll: aircraftRoll,
          nationName: nationName,
          text: resultText
        };
      }
      
      if (tableId === 'B') {
        // Table B: NATO CAP Flight - uses zones structure
        const zoneData = table.zones[atafZone][scenarioDate];
        const nationRoll = Math.floor(Math.random() * 10) + 1;
        
        let selectedNation = null;
        let selectedNationName = '';
        
        // Find which nation this roll corresponds to
        for (const [range, nationData] of Object.entries(zoneData.nations)) {
          const [min, max] = parseRange(range);
          if (nationRoll >= min && nationRoll <= max) {
            selectedNation = nationData;
            selectedNationName = nationData.name;
            break;
          }
        }
        
        if (!selectedNation) {
          return {
            nationRoll: nationRoll,
            aircraftRoll: null,
            text: `Error: No nation found for roll ${nationRoll}`
          };
        }
        
        // Roll for aircraft type
        const aircraftRoll = Math.floor(Math.random() * 10) + 1;
        let selectedAircraft = null;
        
        // Find which aircraft this roll corresponds to
        for (const [range, aircraft] of Object.entries(selectedNation.aircraft)) {
          const [min, max] = parseRange(range);
          if (aircraftRoll >= min && aircraftRoll <= max) {
            selectedAircraft = aircraft;
            break;
          }
        }
        
        if (!selectedAircraft) {
          return {
            nationRoll: nationRoll,
            aircraftRoll: aircraftRoll,
            text: `Error: No aircraft found for roll ${aircraftRoll}`
          };
        }
        
        return {
          nationRoll: nationRoll,
          aircraftRoll: aircraftRoll,
          nationName: selectedNationName,
          text: `${selectedNationName}: 1 x {2} ${selectedAircraft}, CAP`
        };
      }
      
      if (tableId === 'C') {
        // Table C: NATO Bombing Raid - three-tasking system (CAP, SEAD, Bombing)
        const dateVariant = scenarioDate;
        const taskingData = table.taskings;
        
        const results = [];
        const taskings = ['CAP', 'SEAD', 'Bombing'];
        const flightSizes = { 'CAP': 2, 'SEAD': 2, 'Bombing': 4 };
        
        for (const tasking of taskings) {
          const taskingVariant = taskingData[tasking][dateVariant];
          
          // Roll for nation
          const nationRoll = Math.floor(Math.random() * 10) + 1;
          let selectedNation = null;
          let selectedNationName = '';
          
          for (const [range, nationData] of Object.entries(taskingVariant.nations)) {
            const [min, max] = parseRange(range);
            if (nationRoll >= min && nationRoll <= max) {
              selectedNation = nationData;
              selectedNationName = nationData.name;
              break;
            }
          }
          
          if (!selectedNation) {
            results.push({
              tasking: tasking,
              nationRoll: nationRoll,
              aircraftRoll: null,
              text: `Error: No nation found for ${tasking} roll ${nationRoll}`
            });
            continue;
          }
          
          // Roll for aircraft
          const aircraftRoll = Math.floor(Math.random() * 10) + 1;
          let selectedAircraft = null;
          
          for (const [range, aircraft] of Object.entries(selectedNation.aircraft)) {
            const [min, max] = parseRange(range);
            if (aircraftRoll >= min && aircraftRoll <= max) {
              selectedAircraft = aircraft;
              break;
            }
          }
          
          if (!selectedAircraft) {
            results.push({
              tasking: tasking,
              nationRoll: nationRoll,
              aircraftRoll: aircraftRoll,
              text: `Error: No aircraft found for ${tasking} roll ${aircraftRoll}`
            });
            continue;
          }
          
          const flightSize = flightSizes[tasking];
          results.push({
            tasking: tasking,
            nationRoll: nationRoll,
            aircraftRoll: aircraftRoll,
            nationName: selectedNationName,
            text: `4 x {${flightSize}} ${selectedNationName} ${selectedAircraft}, ${tasking}`
          });
        }
        
        return {
          taskingResults: results,
          text: results.map(r => r.text).join('<br>')
        };
      }
      
      // Placeholder for other tables
      return {
        nationRoll: null,
        aircraftRoll: null,
        text: `Placeholder result for Table ${tableId}`
      };
    }

    function getTableResult(tableId) {
      const table = oobTables[tableId];
      
      if (tableId === 'A') {
        // Table A: NATO QRA Flight - two-roll system
        const nationRoll = Math.floor(Math.random() * 10) + 1;
        
        // Determine nation based on roll
        let selectedNation, nationName;
        if (nationRoll >= 1 && nationRoll <= 4) {
          selectedNation = table.nations['1-4'];
          nationName = 'UK';
        } else if (nationRoll >= 5 && nationRoll <= 6) {
          selectedNation = table.nations['5-6'];
          nationName = 'BE/NE';
        } else if (nationRoll >= 7 && nationRoll <= 10) {
          selectedNation = table.nations['7-10'];
          nationName = 'FRG';
        }
        
        // Roll for aircraft within that nation
        const aircraftRoll = Math.floor(Math.random() * 10) + 1;
        let aircraftType = null;
        
        // Find matching aircraft based on roll ranges
        for (const [range, aircraft] of Object.entries(selectedNation.aircraft)) {
          const [min, max] = parseRange(range);
          if (aircraftRoll >= min && aircraftRoll <= max) {
            aircraftType = aircraft;
            // Add nation suffix if not already included
            if (!aircraftType.includes('(') && nationName !== 'FRG') {
              aircraftType += `(${nationName})`;
            }
            break;
          }
        }
        
        const resultText = `1 x {${table.flightSize}} ${aircraftType}`;
        
        return {
          nationRoll: nationRoll,
          aircraftRoll: aircraftRoll,
          text: resultText
        };
      }
      
      // Placeholder for other tables
      return {
        nationRoll: null,
        aircraftRoll: null,
        text: `Placeholder result for Table ${tableId}`
      };
    }
    
    function parseRange(range) {
      if (range.includes('-')) {
        const [min, max] = range.split('-').map(num => parseInt(num));
        return [min, max];
      } else {
        const num = parseInt(range);
        return [num, num];
      }
    }

    function updateResultsDisplay() {
      const container = document.getElementById('resultsList');
      const resultsSection = document.getElementById('resultsSection');
      
      if (results.length === 0) {
        resultsSection.style.display = 'none';
        return;
      }
      
      resultsSection.style.display = 'block';
      
      const resultsHTML = results.map(result => {
        let rollText = '';
        let variableText = '';
        
        if (result.nationRoll && result.aircraftRoll) {
          rollText = `(aircraft: ${result.aircraftRoll})`;
        } else if (result.roll) {
          rollText = `(rolled ${result.roll})`;
        }
        
        if (result.atafZone || result.scenarioDate) {
          const parts = [];
          if (result.atafZone) parts.push(result.atafZone);
          if (result.scenarioDate) parts.push(result.scenarioDate === 'pre' ? 'Pre-6/1/87' : '6/1/87+');
          variableText = ` [${parts.join(', ')}]`;
        }
        
        return `
          <div class="result-item">
            <div class="result-info">
              <div class="result-table">${result.tableName}${variableText}</div>
              <div class="result-text">
                ${result.result}
                <span class="result-roll">${rollText}</span>
              </div>
            </div>
            <button class="action-button remove-result" onclick="removeResult(${result.id})">
              Remove
            </button>
          </div>
        `;
      }).join('');
      
      container.innerHTML = resultsHTML;
    }

    function removeResult(resultId) {
      results = results.filter(result => result.id !== resultId);
      
      // Check if all results are gone
      if (results.length === 0) {
        hasGeneratedResults = false;
        updateDateButtonStates(); // Unlock date selection
      }
      
      updateResultsDisplay();
    }

    function clearAllResults() {
      if (results.length === 0) return;
      
      if (confirm('Are you sure you want to clear all results?')) {
        results = [];
        hasGeneratedResults = false; // Mark that no results exist
        updateDateButtonStates(); // Unlock date selection
        updateResultsDisplay();
      }
    }

    function viewTableStructure(tableId, atafZone, scenarioDate) {
      const table = oobTables[tableId];
      const titleElement = document.getElementById('tableViewTitle');
      const contentElement = document.getElementById('tableViewContent');
      
      let titleText = table.name;
      if (atafZone && scenarioDate) {
        const dateText = scenarioDate === 'pre' ? 'Pre-6/1/87' : '6/1/87 or later';
        titleText += ` [${atafZone}, ${dateText}]`;
      }
      titleElement.textContent = titleText;
      
      if (tableId === 'A') {
        const variant = table.variants[atafZone][scenarioDate];
        let tableHTML = `<div class="table-view-content">`;
        tableHTML += `<div class="table-description">${table.description}</div>`;
        
        // Show nation roll ranges and aircraft for this variant (sorted by roll number)
        const sortedNations = Object.entries(variant.nations).sort((a, b) => {
          const aMin = parseRange(a[0])[0];
          const bMin = parseRange(b[0])[0];
          return aMin - bMin;
        });
        
        for (const [nationRange, nationData] of sortedNations) {
          tableHTML += `<div class="nation-section">`;
          tableHTML += `<div class="nation-header">${nationRange}: ${nationData.name}</div>`;
          tableHTML += `<div class="aircraft-list">`;
          
          for (const [aircraftRange, aircraftType] of Object.entries(nationData.aircraft)) {
            // Use aircraft names exactly as defined in source data
            const displayType = aircraftType;
            tableHTML += `<div class="aircraft-item">${aircraftRange}: ${displayType}</div>`;
          }
          
          tableHTML += `</div></div>`;
        }
        
        tableHTML += `</div>`;
        contentElement.innerHTML = tableHTML;
      } else if (tableId === 'B') {
        const zoneData = table.zones[atafZone][scenarioDate];
        let tableHTML = `<div class="table-view-content">`;
        tableHTML += `<div class="table-description">${table.description}</div>`;
        tableHTML += `<div class="table-result">${table.result}</div>`;
        
        // Show nation roll ranges and aircraft for this zone/date combination (sorted by roll number)
        const sortedNations = Object.entries(zoneData.nations).sort((a, b) => {
          const aMin = parseInt(a[0].split('-')[0]);
          const bMin = parseInt(b[0].split('-')[0]);
          return aMin - bMin;
        });
        
        for (const [nationRange, nationData] of sortedNations) {
          tableHTML += `<div class="nation-section">`;
          tableHTML += `<div class="nation-header">${nationRange}: ${nationData.name}</div>`;
          tableHTML += `<div class="aircraft-list">`;
          
          // Sort aircraft ranges numerically
          const sortedAircraft = Object.entries(nationData.aircraft).sort((a, b) => {
            const aStart = parseInt(a[0].split('-')[0]) || parseInt(a[0]);
            const bStart = parseInt(b[0].split('-')[0]) || parseInt(b[0]);
            return aStart - bStart;
          });
          
          for (const [aircraftRange, aircraftType] of sortedAircraft) {
            tableHTML += `<div class="aircraft-item">${aircraftRange}: ${aircraftType}</div>`;
          }
          
          tableHTML += `</div></div>`;
        }
        
        tableHTML += `</div>`;
        contentElement.innerHTML = tableHTML;
      } else if (tableId === 'C') {
        // Table C: NATO Bombing Raid - show all three taskings
        let tableHTML = `<div class="table-view-content">`;
        tableHTML += `<div class="table-description">${table.description}</div>`;
        tableHTML += `<div class="table-result">${table.result}</div>`;
        
        const taskings = ['CAP', 'SEAD', 'Bombing'];
        const dateVariant = scenarioDate;
        
        for (const tasking of taskings) {
          const taskingData = table.taskings[tasking][dateVariant];
          
          tableHTML += `<div class="tasking-section">`;
          tableHTML += `<div class="tasking-header">${tasking} (4 x {${tasking === 'Bombing' ? '4' : '2'}})</div>`;
          
          // Sort nations by roll number
          const sortedNations = Object.entries(taskingData.nations).sort((a, b) => {
            const aMin = parseInt(a[0].split('-')[0]);
            const bMin = parseInt(b[0].split('-')[0]);
            return aMin - bMin;
          });
          
          for (const [nationRange, nationData] of sortedNations) {
            tableHTML += `<div class="nation-section">`;
            tableHTML += `<div class="nation-header">${nationRange}: ${nationData.name}</div>`;
            tableHTML += `<div class="aircraft-list">`;
            
            // Sort aircraft ranges numerically
            const sortedAircraft = Object.entries(nationData.aircraft).sort((a, b) => {
              const aStart = parseInt(a[0].split('-')[0]) || parseInt(a[0]);
              const bStart = parseInt(b[0].split('-')[0]) || parseInt(b[0]);
              return aStart - bStart;
            });
            
            for (const [aircraftRange, aircraftType] of sortedAircraft) {
              tableHTML += `<div class="aircraft-item">${aircraftRange}: ${aircraftType}</div>`;
            }
            
            tableHTML += `</div></div>`;
          }
          
          tableHTML += `</div>`;
        }
        
        tableHTML += `</div>`;
        contentElement.innerHTML = tableHTML;
      } else {
        contentElement.innerHTML = `<div class="table-view-content">Table data not yet implemented for Table ${tableId}</div>`;
      }
      
      document.getElementById('tableViewOverlay').style.display = 'flex';
    }

    function viewTable() {
      if (!selectedTable) return;
      
      // Check if Table C and scenario date is required
      if (selectedTable === 'C' && !scenarioDate) {
        alert('Please select a scenario date first.');
        return;
      }
      
      // For tables without variables, use default values
      if (selectedTable === 'A') {
        // Default to 2ATAF, pre-6/1/87 for backward compatibility
        viewTableStructure(selectedTable, '2ATAF', 'pre');
      } else if (selectedTable === 'B') {
        // Table B uses global scenario date and default ATAF zone
        const defaultAtaf = '2ATAF';
        const globalDate = scenarioDate || 'pre';
        viewTableStructure(selectedTable, defaultAtaf, globalDate);
      } else if (selectedTable === 'C') {
        // Table C uses global scenario date for all taskings
        const globalDate = scenarioDate || 'pre';
        viewTableStructure(selectedTable, null, globalDate);
      } else {
        // Handle other tables that don't have variables yet
        const table = oobTables[selectedTable];
        const titleElement = document.getElementById('tableViewTitle');
        const contentElement = document.getElementById('tableViewContent');
        
        titleElement.textContent = table.name;
        contentElement.innerHTML = `<div class="table-view-content">Table data not yet implemented for Table ${selectedTable}</div>`;
        document.getElementById('tableViewOverlay').style.display = 'flex';
      }
    }

    function hideTableView() {
      document.getElementById('tableViewOverlay').style.display = 'none';
    }

    // Initialize the app
    updateResultsDisplay();
    updateDateButtonStates(); // Set initial button states
  </script>
</body>
</html>